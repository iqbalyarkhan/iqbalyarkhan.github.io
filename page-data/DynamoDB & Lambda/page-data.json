{"componentChunkName":"component---src-templates-blog-post-js","path":"/DynamoDB & Lambda/","result":{"data":{"site":{"siteMetadata":{"title":"Full(dot)Stack"}},"markdownRemark":{"id":"1c5aea00-085c-593e-b58c-c1fd19f61da4","excerpt":"DynamoDB Streams Code! DynamoDB Let's talk about Amazon's NoSQL database offering: DynamoDB. It is a fully managed NoSQL database service that provides fast and…","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#dynamodb\">DynamoDB</a></p>\n<ul>\n<li><a href=\"#streams\">Streams</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#code\">Code!</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"dynamodb\" style=\"position:relative;\"><a href=\"#dynamodb\" aria-label=\"dynamodb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DynamoDB</h2>\n<p>Let's talk about Amazon's NoSQL database offering: DynamoDB. It is a fully managed NoSQL database service that provides fast and predictable performance with seamless scalability. Detailed docs on using lambda with DynamoDB <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/with-ddb.html\">here</a>.</p>\n<p>You can use an AWS Lambda function to process records in an <a href=\"https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html\">Amazon DynamoDB stream</a>. With DynamoDB Streams, you can trigger a Lambda function to perform additional work each time a DynamoDB table is updated. Lambda reads records from the stream and invokes your function synchronously with an event that contains stream records. Lambda reads records in batches and invokes your function to process records from the batch.</p>\n<p>DynamoDB Streams is a feature that captures data modification events in DynamoDB tables. The data about these events appear in the stream in near-real time, and in the order that the events occurred.</p>\n<p>Each event is represented by a stream record. If you enable a stream on a table, DynamoDB Streams writes a stream record whenever one of the following events occurs:</p>\n<ul>\n<li>A new item is added to the table: The stream captures an image of the entire item, including all of its attributes.</li>\n<li>An item is updated: The stream captures the \"before\" and \"after\" image of any attributes that were modified in the item.</li>\n<li>An item is deleted from the table: The stream captures an image of the entire item before it was deleted.</li>\n</ul>\n<p>Lambda will receive the record in the following format:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Records\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"eventID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"dynamodb\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Keys\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Id\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"N\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"101\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"NewImage\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Message\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"S\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"New item!\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"Id\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"N\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"101\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"StreamViewType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NEW_AND_OLD_IMAGES\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SequenceNumber\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"111\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SizeBytes\"</span><span class=\"token operator\">:</span> <span class=\"token number\">26</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"awsRegion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"us-west-2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"INSERT\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSourceARN\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:us-west-2:111122223333:table/TestTable/stream/2015-05-11T21:21:33.291\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aws:dynamodb\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"eventID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"dynamodb\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"OldImage\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Message\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"S\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"New item!\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"Id\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"N\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"101\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SequenceNumber\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"222\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Keys\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Id\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"N\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"101\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SizeBytes\"</span><span class=\"token operator\">:</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"NewImage\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"Message\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"S\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"This item has changed\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"Id\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"N\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"101\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"StreamViewType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"NEW_AND_OLD_IMAGES\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"awsRegion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"us-west-2\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MODIFY\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSourceARN\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:us-west-2:111122223333:table/TestTable/stream/2015-05-11T21:21:33.291\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aws:dynamodb\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Each stream record also contains the name of the table, the event timestamp, and other metadata. Stream records have a lifetime of 24 hours; after that, they are automatically removed from the stream.</p>\n<p>You can use DynamoDB Streams together with AWS Lambda to create a trigger—code that runs automatically whenever an event of interest appears in a stream. For example, consider a Customers table that contains customer information for a company. Suppose that you want to send a \"welcome\" email to each new customer. You could enable a stream on that table, and then associate the stream with a Lambda function. The Lambda function would run whenever a new stream record appears, but only process new items added to the Customers table. For any item that has an <code class=\"language-text\">EmailAddress</code> attribute, the Lambda function would invoke Amazon Simple Email Service (Amazon SES) to send an email to that address.</p>\n<h3 id=\"streams\" style=\"position:relative;\"><a href=\"#streams\" aria-label=\"streams permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Streams</h3>\n<p>More details <a href=\"https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.html#:~:text=a%20new%20one.-,Reading%20and%20processing%20a%20stream,-To%20read%20and\">here</a></p>\n<p>A stream consists of stream records. Each stream record represents a single data modification in the DynamoDB table to which the stream belongs. Each stream record is assigned a sequence number, reflecting the order in which the record was published to the stream.</p>\n<p>Stream records are organized into groups, or shards. Each shard acts as a container for multiple stream records, and contains information required for accessing and iterating through these records. The stream records within a shard are removed automatically after 24 hours.</p>\n<p>Shards are ephemeral: They are created and deleted automatically, as needed. Any shard can also split into multiple new shards; this also occurs automatically. (It's also possible for a parent shard to have just one child shard.) A shard might split in response to high levels of write activity on its parent table, so that applications can process records from multiple shards in parallel.</p>\n<p>The following diagram shows the relationship between a stream, shards in the stream, and stream records in the shards:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/62f4344be112e1c724ab66e802f1d860/5fc9a/shards.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.06329113924051%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABD0lEQVR42pVTyaqEQAz0/79NLyLiQQRxw33flwwViO+NOMMYCOmkuyuVslXoR9v3nYIgoHEcv55TroV1Xamua/aqqtglT5KEyrI8cznTtu094LZtDNj3PfswDBxxsWmaN3CAgK2cPQGnaeKLXdfRPM90HAevwSTPcwZCjjVqAEVNGKdpSsuy/AGik6ZpZNs2bwDQdV0yDINUVSXHcSiKItJ1nUzTJMuyuOZ53llDQxjuKqIbRMfIcDCWcTEWmoqeYIkc+9hDxJS3GqIDWGZZ9uYYKwxDZur7/lmTWBTF56/8ycAcjKDzo2cjTK8OSfAhIM/dmUcMAQY9MR4i2D5ieDXoir8kjmPWUt7df2YC+AI1nlfTT+qrMgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Shard\"\n        title=\"\"\n        src=\"/static/62f4344be112e1c724ab66e802f1d860/f058b/shards.png\"\n        srcset=\"/static/62f4344be112e1c724ab66e802f1d860/c26ae/shards.png 158w,\n/static/62f4344be112e1c724ab66e802f1d860/6bdcf/shards.png 315w,\n/static/62f4344be112e1c724ab66e802f1d860/f058b/shards.png 630w,\n/static/62f4344be112e1c724ab66e802f1d860/40601/shards.png 945w,\n/static/62f4344be112e1c724ab66e802f1d860/78612/shards.png 1260w,\n/static/62f4344be112e1c724ab66e802f1d860/5fc9a/shards.png 1648w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The AWS Lambda service polls the stream for new records four times per second. When new stream records are available, your Lambda function is synchronously invoked. You can subscribe up to two Lambda functions to the same DynamoDB stream. Let's look at an example setup where a DynamoDB table is created and has a lambda listening to its streams.</p>\n<h2 id=\"code\" style=\"position:relative;\"><a href=\"#code\" aria-label=\"code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code!</h2>\n<p>Let's start by creating our lambda via the CDK. This is the same lambda we've seen in the past for Lambda -> SQS flow only with different permissions:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">  <span class=\"token keyword\">private</span> <span class=\"token function\">createLambdaFunction</span><span class=\"token punctuation\">(</span>tableStreamArn<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> lambdaRole <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Role</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DynamoDBStreamLambdaRole\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      assumedBy<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServicePrincipal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      roleName<span class=\"token operator\">:</span> <span class=\"token string\">\"DynamoDBStreamLambdaRole\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    lambdaRole<span class=\"token punctuation\">.</span><span class=\"token function\">addToPolicy</span><span class=\"token punctuation\">(</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">PolicyStatement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        actions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"dynamodb:DescribeStream\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"dynamodb:GetRecords\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"dynamodb:GetShardIterator\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"dynamodb:ListStreams\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        resources<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>tableStreamArn<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    lambdaRole<span class=\"token punctuation\">.</span><span class=\"token function\">addManagedPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      managedPolicyArn<span class=\"token operator\">:</span>\n        <span class=\"token string\">\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> lambda <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NodejsFunction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DynamoDBStreamLambda\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      functionName<span class=\"token operator\">:</span> <span class=\"token string\">\"DynamoDBStreamLambda\"</span><span class=\"token punctuation\">,</span>\n      runtime<span class=\"token operator\">:</span> Runtime<span class=\"token punctuation\">.</span><span class=\"token constant\">NODEJS_18_X</span><span class=\"token punctuation\">,</span>\n      handler<span class=\"token operator\">:</span> <span class=\"token string\">\"handler\"</span><span class=\"token punctuation\">,</span>\n      entry<span class=\"token operator\">:</span> <span class=\"token string\">\"lambdas/dynamoDBStreamLambda.ts\"</span><span class=\"token punctuation\">,</span>\n      tracing<span class=\"token operator\">:</span> Tracing<span class=\"token punctuation\">.</span><span class=\"token constant\">ACTIVE</span><span class=\"token punctuation\">,</span>\n      memorySize<span class=\"token operator\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span>\n      timeout<span class=\"token operator\">:</span> Duration<span class=\"token punctuation\">.</span><span class=\"token function\">seconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      role<span class=\"token operator\">:</span> lambdaRole<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> lambda<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next up, here's how we create our dynamoDB:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">  <span class=\"token keyword\">private</span> <span class=\"token function\">createDynamoDBTable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> dynamoDBTable <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Table</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CustomerOrdersTable\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      tableName<span class=\"token operator\">:</span> <span class=\"token string\">\"CustomerOrdersTable\"</span><span class=\"token punctuation\">,</span>\n      partitionKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">:</span> AttributeType<span class=\"token punctuation\">.</span><span class=\"token constant\">STRING</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      stream<span class=\"token operator\">:</span> StreamViewType<span class=\"token punctuation\">.</span><span class=\"token constant\">NEW_IMAGE</span><span class=\"token punctuation\">,</span>\n      billingMode<span class=\"token operator\">:</span> BillingMode<span class=\"token punctuation\">.</span><span class=\"token constant\">PAY_PER_REQUEST</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> dynamoDBTable<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice the <code class=\"language-text\">stream</code> value above. DynamoDB <code class=\"language-text\">StreamViewType</code> determines what information is captured in the DynamoDB stream when a data modification occurs. There are four possible <code class=\"language-text\">StreamViewTypes</code>:</p>\n<ul>\n<li><code class=\"language-text\">KEYS_ONLY</code>: Only the key attributes of the modified item are written to the stream.</li>\n<li><code class=\"language-text\">NEW_IMAGE</code>: The entire item, as it appears after the modification, is written to the stream.</li>\n<li><code class=\"language-text\">OLD_IMAGE</code>: The entire item, as it appeared before the modification, is written to the stream.</li>\n<li><code class=\"language-text\">NEW_AND_OLD_IMAGES</code>: Both the new and old images of the item are written to the stream.</li>\n</ul>\n<p>You can choose the <code class=\"language-text\">StreamViewType</code> when enabling a DynamoDB stream for a table. Once a stream has been set up, it is not possible to edit the <code class=\"language-text\">StreamViewType</code>.</p>\n<p>Next up, we need to set up event source for our lambda (ie what would trigger the lambda):</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lambda<span class=\"token punctuation\">.</span><span class=\"token function\">addEventSource</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">DynamoEventSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dynamoDBTable<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    startingPosition<span class=\"token operator\">:</span> StartingPosition<span class=\"token punctuation\">.</span><span class=\"token constant\">TRIM_HORIZON</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <code class=\"language-text\">StartingPosition</code> parameter is used to specify the point at which the application reads from the DynamoDB stream. There are three possible values for <code class=\"language-text\">StartingPosition</code>:</p>\n<ul>\n<li><code class=\"language-text\">NOW</code>: This value allows you to start reading just after the most recent record in the stream, starting at the timestamp of the customer's request.</li>\n<li><code class=\"language-text\">TRIM_HORIZON</code>: With this value, you can start reading at the last untrimmed record in the stream, which is the oldest record available in the stream.</li>\n<li><code class=\"language-text\">LAST_STOPPED_POINT</code>: This value is used to resume reading from where the application last stopped reading.</li>\n</ul>\n<p>With what we've defined above, lambda will read the oldest available record in the stream.</p>\n<p>Here's the sample payload received in our lambda when we create a new entry in our DDB:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"level\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"INFO\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"message\"</span><span class=\"token operator\">:</span> \"received the following <span class=\"token keyword\">in</span> dynamoDB lambda<span class=\"token operator\">:</span>\n    <span class=\"token punctuation\">{</span>\n      \\\"Records\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          \\\"eventID\\\"<span class=\"token operator\">:</span>\\\"05b1ab76243a9468ea07014fa793ed3d\\\"<span class=\"token punctuation\">,</span>\n          \\\"eventName\\\"<span class=\"token operator\">:</span>\\\"<span class=\"token constant\">INSERT</span>\\\"<span class=\"token punctuation\">,</span>\n          \\\"eventVersion\\\"<span class=\"token operator\">:</span>\\\"<span class=\"token number\">1.1</span>\\\"<span class=\"token punctuation\">,</span>\n          \\\"eventSource\\\"<span class=\"token operator\">:</span>\\\"aws<span class=\"token operator\">:</span>dynamodb\\\"<span class=\"token punctuation\">,</span>\n          \\\"awsRegion\\\"<span class=\"token operator\">:</span>\\\"us<span class=\"token operator\">-</span>east<span class=\"token operator\">-</span><span class=\"token number\">1</span>\\\"<span class=\"token punctuation\">,</span>\n          \\\"dynamodb\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\\\"ApproximateCreationDateTime\\\"<span class=\"token operator\">:</span><span class=\"token number\">1703457600</span><span class=\"token punctuation\">,</span>\n          \\\"Keys\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\\\"id\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\\\"<span class=\"token constant\">S</span>\\\"<span class=\"token operator\">:</span>\\\"<span class=\"token number\">1</span>\\\"<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          \\\"NewImage\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\n            \\\"customerEmail\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\\\"<span class=\"token constant\">S</span>\\\"<span class=\"token operator\">:</span>\\\"firstcustomer<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">gmail</span></span><span class=\"token punctuation\">.</span>com\\\"<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            \\\"id\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\\\"<span class=\"token constant\">S</span>\\\"<span class=\"token operator\">:</span>\\\"<span class=\"token number\">1</span>\\\"<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            \\\"customerName\\\"<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\\\"<span class=\"token constant\">S</span>\\\"<span class=\"token operator\">:</span>\\\"First Customer\\\"<span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          \\\"SequenceNumber\\\"<span class=\"token operator\">:</span>\\\"<span class=\"token number\">100000000078416239681</span>\\\"<span class=\"token punctuation\">,</span>\n          \\\"SizeBytes\\\"<span class=\"token operator\">:</span><span class=\"token number\">68</span><span class=\"token punctuation\">,</span>\n          \\\"StreamViewType\\\"<span class=\"token operator\">:</span>\\\"<span class=\"token constant\">NEW_IMAGE</span>\\\"<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          \\\"eventSourceARN\\\"<span class=\"token operator\">:</span>\\\"arn<span class=\"token operator\">:</span>aws<span class=\"token operator\">:</span>dynamodb<span class=\"token operator\">:</span>us<span class=\"token operator\">-</span>east<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">063712744160</span><span class=\"token operator\">:</span>table<span class=\"token operator\">/</span>CustomerOrdersTable<span class=\"token operator\">/</span>stream<span class=\"token operator\">/</span><span class=\"token number\">2023</span><span class=\"token operator\">-</span><span class=\"token number\">12</span><span class=\"token operator\">-</span>24T22<span class=\"token operator\">:</span><span class=\"token number\">29</span><span class=\"token operator\">:</span><span class=\"token number\">00.593</span>\\\"\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\"<span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"service\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service_undefined\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"timestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2023-12-24T22:40:01.104Z\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"xray_trace_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1-6588b340-28a13a3ce35cb81a845225ba\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>and here's what the lambda code looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">DynamoDBStreamEvent</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"aws-lambda\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Logger <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@aws-lambda-powertools/logger\"</span>\n\n<span class=\"token keyword\">const</span> logger <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Logger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * Reads from SQS\n * @param event\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> DynamoDBStreamEvent<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Get the object from the event and show its content type</span>\n  <span class=\"token class-name\">logger</span><span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">received the following in dynamoDB lambda: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"AWS Lambda & DynamoDB","date":"October 28, 2023","description":"Lambda with DynamoDB as event source"}},"previous":{"fields":{"slug":"/AWS Lambda & SQS/"},"frontmatter":{"title":"AWS Lambda & SQS"}},"next":null},"pageContext":{"id":"1c5aea00-085c-593e-b58c-c1fd19f61da4","previousPostId":"ceb323b3-6847-591f-8c78-f262364ed696","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}
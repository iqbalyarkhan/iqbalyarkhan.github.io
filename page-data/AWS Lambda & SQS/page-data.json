{"componentChunkName":"component---src-templates-blog-post-js","path":"/AWS Lambda & SQS/","result":{"data":{"site":{"siteMetadata":{"title":"Full(dot)Stack"}},"markdownRemark":{"id":"ceb323b3-6847-591f-8c78-f262364ed696","excerpt":"Intro Architecture SQS Standard Queues FIFO queues Identifiers for SQS Using lambda with SQS Event source mappings DLQs Code! Appendix Intro One of the most…","html":"<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#intro\">Intro</a></p>\n</li>\n<li>\n<p><a href=\"#architecture\">Architecture</a></p>\n</li>\n<li>\n<p><a href=\"#sqs\">SQS</a></p>\n<ul>\n<li><a href=\"#standard-queues\">Standard Queues</a></li>\n<li><a href=\"#fifo-queues\">FIFO queues</a></li>\n<li><a href=\"#identifiers-for-sqs\">Identifiers for SQS</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#using-lambda-with-sqs\">Using lambda with SQS</a></p>\n<ul>\n<li><a href=\"#event-source-mappings\">Event source mappings</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#dlqs\">DLQs</a></p>\n</li>\n<li>\n<p><a href=\"#code\">Code!</a></p>\n</li>\n<li>\n<p><a href=\"#appendix\">Appendix</a></p>\n</li>\n</ul>\n</div>\n<h2 id=\"intro\" style=\"position:relative;\"><a href=\"#intro\" aria-label=\"intro permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intro</h2>\n<p>One of the most common patterns in serverless applications is triggering a lambda when an SQS queue receives a message. This is called using SQS as an event source for lambda. Let's look at the simple architecture we're building:</p>\n<h2 id=\"architecture\" style=\"position:relative;\"><a href=\"#architecture\" aria-label=\"architecture permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Architecture</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 286px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e754d2c60226fb4b4797a6a62c49d5b8/357e3/QueueWithDLQ.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.13924050632912%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACaElEQVR42qWTW0gUYRTH5zGCHgqqp4IgejCphyKiCKMwinooSHqLiKACX8qQrCQtUzNlvaR0ge2mkbBRUgqZ3ciy0tVcNUq8VNq6uzOzuTvrzu7szv7and0EIUPXw5z55nwMv3O+/3eO4FyRj2N5Hs6UIsPt80/hq3iDYWGdf1okYiz6aA/BxgLUO4fR3t6M7usIjmV5uDaUIW6tQtpezdiSsyglL6YHJmBoKn5TOmrtUYIt5SgnFxP63IAgbqnEfagO98Fafh+rR06vwVXQhKz5kF0SsixPdUlEHPfR3VyP/3wKgaf5hL+3M3FhDaolG8GZWoy08xqutErEPdeJxUrpy3gxoXC0oMhU1+NVTziG8VzdhxYFag25qI9zUZ6ZEOwLshlbmMN4yhWkVYWMCMdRip7PSENvVyMe0y6U4s2MW86gKW4E9ZEN5X4H73PMDFU0EXjQhdbnmKrXNBbUQvTbOuhtbWZ0ZMTYE2Kvn047dU8stHZ94v+Iv3nif0miyLu2D7S2fcRqtRpyGMDB/gE626302XrR/CozoiZMj0K8Xu9kLJCsxZLqEUKahiRJxncknKgwdoRYJl3XZ81VAwEGfwxPSjH7CvW4HoGWb3gyHyKesDBwxIw3qwFPbmMSwEQreS9Fb1bIxLW6GDm1xJgw+6LTyQOVsleIG03I+82IO2pwZ9xC3FQ+B6DptTH/sZGVD9w2VnFb9RyOXNjMr3lZONeX4lh7GcfKi4wtPZf8pfjvteNaV4qy14wv4y5SWhXy7hvJ92Gs54g+/V++0tfZTXBCNeLkgYnxGxoeorvHRiDaj7FJ+QNaMSXxwlCsawAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SQS-Lambda\"\n        title=\"\"\n        src=\"/static/e754d2c60226fb4b4797a6a62c49d5b8/357e3/QueueWithDLQ.png\"\n        srcset=\"/static/e754d2c60226fb4b4797a6a62c49d5b8/c26ae/QueueWithDLQ.png 158w,\n/static/e754d2c60226fb4b4797a6a62c49d5b8/357e3/QueueWithDLQ.png 286w\"\n        sizes=\"(max-width: 286px) 100vw, 286px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The flow is quite simple: We send a message to the SQS queue from console (for now) and have the lambda print the received message. Any errors go into the DLQ. Here's a sample output from lambda logs:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2023-10-27T23:48:53.251Z\t74f78d0e-7faa-506e-ae9a-d0b83136e687\tINFO\trecord: {\n    \"messageId\": \"67fc17f2\",\n    \"receiptHandle\": \"AQEBx\",\n    \"body\": \"This is a test message from the console my friend!\",\n    \"attributes\": {\n        \"ApproximateReceiveCount\": \"1\",\n        \"SentTimestamp\": \"1698450532855\",\n        \"SenderId\": \"AIDA\",\n        \"ApproximateFirstReceiveTimestamp\": \"1698450532865\"\n    },\n    \"messageAttributes\": {},\n    \"md5OfBody\": \"405ss\",\n    \"eventSource\": \"aws:sqs\",\n    \"eventSourceARN\": \"arn:aws:sqs:us-east-1:X:SQSToLambdaStack-notificationsQueue8852CCBB-6OA4tVr4CWFS\",\n    \"awsRegion\": \"us-east-1\"\n}</code></pre></div>\n<h2 id=\"sqs\" style=\"position:relative;\"><a href=\"#sqs\" aria-label=\"sqs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQS</h2>\n<p>More details on architecture can be found <a href=\"https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-basic-architecture.html\">here</a></p>\n<p>In the scenario above, our system has a producer (components that send messages to the queue, ie me!) and consumers (components that receive messages from the queue ie lambda). The queue redundantly stores the messages across multiple Amazon SQS servers:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6271aadd6bbc62832e9aabb9580ed521/df438/queue-distributed.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABjElEQVR42oVS207CQBDt/7/4BWriqyG+qCExQSCi4RIFIkWgUAq0WKBcir3utsedLVEjJm6y6e6cmbPnzFThnMM0Lei6Dtd18d+K4xjT6RS2bSNN0yNcoeBoNERXVREEwVFCkiRg4tGYMVD5drdDrV5Hu91GEIbgB5wxLs8KJXa1EfKlMjTDkCQ/XyacSCkWhx44j+WdNi1y6PseosiTuUokLJRqNVxc5dDp9/8kpDtFfKeLpT3GRqjknMHzsha1ek3cPVWkSoWJgt5whELlEYZpHhPGHEtngZmdYer4Hb2OhufSDWaLzBEpNKyVaEEkLAuFxWoV57lLqNrgm/BAGuxcvBXyuH6oiv6tqRyhu4cz1sHJcuTD1MswV3NpXyocGhNUGg3M5vMjhdSSWChg4rzRX2G93KNn7RGsBvBXfWH7A87ahu3YgjDJenhbLOHk7BRNtfOHZfY1gHC7gzMxoS9dLDstLNS2VJkKnCYsh0IyiZSJJlPg98p+CSa/VJTQgNJEDkBuwkUt5ZDlTxfCsEDrLrxUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SQS-Distributed\"\n        title=\"\"\n        src=\"/static/6271aadd6bbc62832e9aabb9580ed521/f058b/queue-distributed.png\"\n        srcset=\"/static/6271aadd6bbc62832e9aabb9580ed521/c26ae/queue-distributed.png 158w,\n/static/6271aadd6bbc62832e9aabb9580ed521/6bdcf/queue-distributed.png 315w,\n/static/6271aadd6bbc62832e9aabb9580ed521/f058b/queue-distributed.png 630w,\n/static/6271aadd6bbc62832e9aabb9580ed521/40601/queue-distributed.png 945w,\n/static/6271aadd6bbc62832e9aabb9580ed521/78612/queue-distributed.png 1260w,\n/static/6271aadd6bbc62832e9aabb9580ed521/df438/queue-distributed.png 1556w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The following scenario describes the lifecycle of an Amazon SQS message in a queue, from creation to deletion.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/43d53e4ce7f2c976a338dad54a7b4583/21482/lifecycle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 93.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAADQUlEQVR42mWU22/TSBTG80fv476ildCKJ4QQiFY8tXSXoEoUtdy7gs0WbUu5hDhx4yTk0tiO49iN7x5/nDNjm7aMdDTjyeTzd87vjBuwLIgsQ0qRlSGEgBxFgYLWYRRe3QftFyp+DrVuoNmEd36Ob1oHk/EY30cjLBYORHnY9Xw8e3eIr+02PM8r31MgjmMZQuTIZRRSssEHVv4a+miKU62Ll60WzNkIYu0g922Y4x7G5hx5Tu7JYGC3kTinSOghSWL54iiK4A/3kCcrJTiYTLH9bB93t7Zwc3MD/Y9v4B9tYv78D3if9sqMBLkAwmUf8aor3cRRgND6SPMFEk+HyGMlqBkGNpqP8aD5F+5sPcTcodQiA6nzX51inucIQ66lQBSS0OwfhGuX5jeIaE4y0AuFEkzSFM5yiaXrwqVgANeLzXucGgsn7Mw8IkeJ/DVNk7KeJJjT23/SQ+2oKPdZICexy88Mghio3/Ks3Ocz7HB3FwG5GxBdpjymGA2H0PUezLmC8frDMTpdDS6dK7uJgETKFQuRIMNRlE0T/mqFbk+H1u2i3enAdpa4iFISK+C4Kxwef4BlWySQIfSmiF2NypRJyuw8ilOsp4cQsaNquHA9nHb79MdjbO8fYGa0UZgaYmuIdDmua8mFCZc6EqulKJPDaGUQ5TUC6xiiapuuMcC9Rzu4tfEAN+7fg/7/c/itDTj/3sHaOLoCJSVncZIitL8gDDysR0+RXJwjFaqmZR9O8OTlC+y+foG/D/akY2phxOarGlJGh2vKlGo4OaBG9mrKXFOG1RDVnbx+L+Wz6r/qztbUOZi6JK+oZ2UnNPD+PSLHgbVY0B1ewLZt2OXask15Q/bffYZujGRDV46Vq4TERd1mSvDkBJ5loqNpMM7OoPd6RLyHDtEeDIZ0O9b4/fYWDlsndDMuSCiVDjl9FmTXPFdrWcMgjDCzHAymU3wmYc/35Y8cnEpMNeORX6ojB1OuYF0R/D6bY/fVW2w2n+BPIj2hz1mVWjUqJyyiUs0RBIF8ZtccteC3/hnu7uzg/qOHeLr9G+bm9BdBdqI+Dmqu0qw+GtW6/B760Pp9nA0NjIdfZQrXhwKR1qQrqpfpM5QfJ72itqBmHv0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SQS-Lifecycle\"\n        title=\"\"\n        src=\"/static/43d53e4ce7f2c976a338dad54a7b4583/f058b/lifecycle.png\"\n        srcset=\"/static/43d53e4ce7f2c976a338dad54a7b4583/c26ae/lifecycle.png 158w,\n/static/43d53e4ce7f2c976a338dad54a7b4583/6bdcf/lifecycle.png 315w,\n/static/43d53e4ce7f2c976a338dad54a7b4583/f058b/lifecycle.png 630w,\n/static/43d53e4ce7f2c976a338dad54a7b4583/40601/lifecycle.png 945w,\n/static/43d53e4ce7f2c976a338dad54a7b4583/78612/lifecycle.png 1260w,\n/static/43d53e4ce7f2c976a338dad54a7b4583/21482/lifecycle.png 1350w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>\n<p>A producer (component 1) sends message A to a queue, and the message is distributed across the Amazon SQS servers redundantly.</p>\n</li>\n<li>\n<p>When a consumer (component 2) is ready to process messages, it consumes messages from the queue, and message A is returned. While message A is being processed, it remains in the queue and isn't returned to subsequent receive requests for the duration of the visibility timeout.</p>\n</li>\n<li>\n<p>The consumer (component 2) deletes message A from the queue to prevent the message from being received and processed again when the visibility timeout expires.</p>\n</li>\n</ol>\n<p>Amazon SQS automatically deletes messages that have been in a queue for more than the maximum message retention period. The default message retention period is 4 days. However, you can set the message retention period to a value from 60 seconds to 1,209,600 seconds (14 days).</p>\n<p>Amazon SQS supports two types of queues – standard queues and FIFO queues:</p>\n<h3 id=\"standard-queues\" style=\"position:relative;\"><a href=\"#standard-queues\" aria-label=\"standard queues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Standard Queues</h3>\n<ul>\n<li>Unlimited Throughput: Standard queues support a nearly unlimited number of API calls per second, per API action</li>\n<li>At-Least-Once Delivery: A message is delivered at least once, but occasionally more than one copy of a message is delivered. Amazon SQS stores copies of your messages on multiple servers for redundancy and high availability. On rare occasions, one of the servers that stores a copy of a message might be unavailable when you receive or delete a message. If this occurs, the copy of the message isn't deleted on that unavailable server, and you might get that message copy again when you receive messages. Design your applications to be idempotent (they should not be affected adversely when processing the same message more than once).</li>\n<li>Best-Effort Ordering: Occasionally, messages are delivered in an order different from which they were sent. It makes a best effort to preserve the order of messages, but more than one copy of a message might be delivered out of order.</li>\n<li>Use standard queues to send data between applications when the throughput is important, for example:\n<ul>\n<li>Decouple live user requests from intensive background work: let users upload media while resizing or encoding it.</li>\n<li>Allocate tasks to multiple worker nodes: process a high number of credit card validation requests.</li>\n<li>Batch messages for future processing: schedule multiple entries to be added to a database.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"fifo-queues\" style=\"position:relative;\"><a href=\"#fifo-queues\" aria-label=\"fifo queues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FIFO queues</h3>\n<ul>\n<li>High Throughput: If you use batching, FIFO queues support up to 3,000 messages per second, per API method (SendMessageBatch, ReceiveMessage, or DeleteMessageBatch). The 3,000 messages per second represent 300 API calls, each with a batch of 10 messages.</li>\n<li>Exactly-Once Processing: A message is delivered once and remains available until a consumer processes and deletes it. Duplicates aren't introduced into the queue.</li>\n<li>First-In-First-Out Delivery: The order in which messages are sent and received is strictly preserved.</li>\n</ul>\n<h3 id=\"identifiers-for-sqs\" style=\"position:relative;\"><a href=\"#identifiers-for-sqs\" aria-label=\"identifiers for sqs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Identifiers for SQS</h3>\n<p>In the payload we saw earlier, there were a few different items. Let's look at each:</p>\n<ul>\n<li>Message Id: Each message receives a system-assigned message ID that Amazon SQS returns to you in the SendMessage response. This identifier is useful for identifying messages. The maximum length of a message ID is 100 characters.</li>\n<li>Receipt handle: Every time you receive a message from a queue, you receive a receipt handle for that message. This handle is associated with the action of receiving the message, not with the message itself. To delete the message or to change the message visibility, you must provide the receipt handle (not the message ID). Thus, you must always receive a message before you can delete it (you can't put a message into the queue and then recall it). The maximum length of a receipt handle is 1,024 characters.</li>\n</ul>\n<h2 id=\"using-lambda-with-sqs\" style=\"position:relative;\"><a href=\"#using-lambda-with-sqs\" aria-label=\"using lambda with sqs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using lambda with SQS</h2>\n<p>You can use an AWS Lambda function to process messages in an Amazon SQS queue. Lambda polls the queue and invokes your Lambda function synchronously with an event that contains queue messages. To allow your function time to process each batch of records, set the source queue's visibility timeout to at least six times the <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/configuration-function-common.html#configuration-common-summary\">timeout that you configure</a> on your function. The extra time allows for Lambda to retry if your function is throttled while processing a previous batch.</p>\n<p>You can specify another queue to act as a dead-letter queue for messages that your Lambda function can't process.</p>\n<p>The Lambda execution role must include the following permissions:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">sqs<span class=\"token operator\">:</span> DeleteMessage\n\nsqs<span class=\"token operator\">:</span> GetQueueAttributes\n\nsqs<span class=\"token operator\">:</span> ReceiveMessage</code></pre></div>\n<p>If you associate an encrypted queue with a Lambda function, add the <code class=\"language-text\">kms:Decrypt</code> permission to the Lambda execution role.</p>\n<h3 id=\"event-source-mappings\" style=\"position:relative;\"><a href=\"#event-source-mappings\" aria-label=\"event source mappings permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Event source mappings</h3>\n<p>Event source mappings allow us to determine what invokes the lambda. Lambda polls the queue and invokes your Lambda function synchronously with an event that contains queue messages. Lambda reads messages in batches and invokes your function once for each batch. When your function successfully processes a batch, Lambda deletes its messages from the queue.</p>\n<p>When Lambda reads a batch, the messages stay in the queue but are hidden for the length of the queue's visibility timeout. If your function successfully processes the batch, Lambda deletes the messages from the queue. <strong>By default, if your function encounters an error while processing a batch, all messages in that batch become visible in the queue again</strong>. For this reason, your function code must be able to process the same message multiple times without unintended side effects.</p>\n<p>To prevent Lambda from processing a message multiple times, you can either configure your event source mapping to include <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html#services-sqs-batchfailurereporting\">batch item failures</a> in your function response, or you can use the Amazon SQS API action <a href=\"https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_DeleteMessage.html\">DeleteMessage</a> to remove messages from the queue as your Lambda function successfully processes them.</p>\n<p>Example SQS message event looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Records\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"messageId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"059f36b4-87a3-44ab-83d2-661975830a7d\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"receiptHandle\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a...\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"body\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Test message.\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"attributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"ApproximateReceiveCount\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SentTimestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1545082649183\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SenderId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AIDAIENQZJOLO23YVJ4VO\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"ApproximateFirstReceiveTimestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1545082649185\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"messageAttributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"md5OfBody\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"e4e68fb7bd0e697a0ae8f1bb342846b3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aws:sqs\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSourceARN\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:sqs:us-east-2:123456789012:my-queue\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"awsRegion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"us-east-2\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"messageId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2e1424d4-f796-459a-8184-9c92662be6da\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"receiptHandle\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AQEBzWwaftRI0KuVm4tP+/7q1rGgNqicHq...\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"body\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Test message.\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"attributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"ApproximateReceiveCount\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SentTimestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1545082650636\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SenderId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AIDAIENQZJOLO23YVJ4VO\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"ApproximateFirstReceiveTimestamp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1545082650649\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"messageAttributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"md5OfBody\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"e4e68fb7bd0e697a0ae8f1bb342846b3\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"aws:sqs\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"eventSourceARN\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:sqs:us-east-2:123456789012:my-queue\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"awsRegion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"us-east-2\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>By default:</p>\n<ul>\n<li>Lambda polls up to 10 messages in your queue at once and sends that batch to your function.</li>\n<li>To avoid invoking the function with a small number of records, you can tell the event source to buffer records for up to 5 minutes by configuring a <strong>batch window</strong>.</li>\n<li>Before invoking the function, Lambda continues to poll messages from the SQS standard queue until:\n<ul>\n<li>The batch window expires</li>\n<li>The invocation payload size quota is reached, or</li>\n<li>The configured maximum batch size is reached.</li>\n</ul>\n</li>\n</ul>\n<p><strong>If you're using a batch window and your SQS queue contains very low traffic, Lambda might wait for up to 20 seconds before invoking your function. This is true even if you set a batch window lower than 20 seconds.</strong></p>\n<h2 id=\"dlqs\" style=\"position:relative;\"><a href=\"#dlqs\" aria-label=\"dlqs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DLQs</h2>\n<p>Amazon SQS supports dead-letter queues (DLQ), which other queues (source queues) can target for messages that can't be processed (consumed) successfully. Dead-letter queues are useful for debugging your application or messaging system because they let you isolate unconsumed messages to determine why their processing didn't succeed.</p>\n<p>The main task of a dead-letter queue is to handle the lifecycle of unconsumed messages. A dead-letter queue lets you set aside and isolate messages that can't be processed correctly to determine why their processing didn't succeed. Setting up a dead-letter queue allows you to do the following:</p>\n<ul>\n<li>Configure an alarm for any messages moved to a dead-letter queue.</li>\n<li>Examine logs for exceptions that might have caused messages to be moved to a dead-letter queue.</li>\n<li>Analyze the contents of messages moved to a dead-letter queue to diagnose software or the producer's or consumer's hardware issues.</li>\n<li>Determine whether you have given your consumer sufficient time to process messages.</li>\n</ul>\n<p>The redrive policy specifies the source queue, the dead-letter queue, and the conditions under which Amazon SQS moves messages from the former to the latter if the consumer of the source queue fails to process a message a specified number of times. The <code class=\"language-text\">maxReceiveCount</code> is the number of times a consumer tries receiving a message from a queue without deleting it before being moved to the dead-letter queue. Setting the <code class=\"language-text\">maxReceiveCount</code> to a low value such as 1 would result in any failure to receive a message to cause the message to be moved to the dead-letter queue. Such failures include network errors and client dependency errors. To ensure that your system is resilient against errors, set the <code class=\"language-text\">maxReceiveCount</code> high enough to allow for sufficient retries.</p>\n<p>The redrive task uses Amazon SQS's <code class=\"language-text\">SendMessageBatch</code>, <code class=\"language-text\">ReceiveMessage</code>, and <code class=\"language-text\">DeleteMessageBatch</code> APIs on behalf of the user to redrive the messages. Therefore, all redriven messages are considered new messages with a new <code class=\"language-text\">messageid</code>, <code class=\"language-text\">enqueueTime</code>, and <code class=\"language-text\">retention period</code>.</p>\n<p>For standard queues, the expiration of a message is always based on its original enqueue timestamp. When a message is moved to a dead-letter queue, the enqueue timestamp is unchanged. The <code class=\"language-text\">ApproximateAgeOfOldestMessage</code> metric indicates when the message moved to the dead-letter queue, not when the message was originally sent. For example, assume that a message spends 1 day in the original queue before it's moved to a dead-letter queue. If the dead-letter queue's retention period is 4 days, the message is deleted from the dead-letter queue after 3 days and the <code class=\"language-text\">ApproximateAgeOfOldestMessage</code> is 3 days. Thus, it is a best practice to always set the retention period of a dead-letter queue to be longer than the retention period of the original queue.</p>\n<h2 id=\"code\" style=\"position:relative;\"><a href=\"#code\" aria-label=\"code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code!</h2>\n<p>Now that we understand SQS queues and Lambdas (a little!), let's look at the CDK and lambda code for our daigram.</p>\n<h2 id=\"appendix\" style=\"position:relative;\"><a href=\"#appendix\" aria-label=\"appendix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Appendix</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-basic-architecture.html\">SQS Architecture</a></li>\n<li><a href=\"https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html\">Using lambda with SQS</a></li>\n</ul>","frontmatter":{"title":"AWS Lambda & SQS","date":"October 27, 2023","description":"Lambda with SQS as event source"}},"previous":{"fields":{"slug":"/typescript/"},"frontmatter":{"title":"Typescript"}},"next":null},"pageContext":{"id":"ceb323b3-6847-591f-8c78-f262364ed696","previousPostId":"f4b72fcc-a116-59db-a469-421086235b56","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}